
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>brian2cuda.device &#8212; brian2cuda 1.0.0 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for brian2cuda.device</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Module implementing the CUDA &quot;standalone&quot; device.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">chain</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">brian2.codegen.cpp_prefs</span> <span class="k">import</span> <span class="n">get_compiler_and_args</span>
<span class="kn">from</span> <span class="nn">brian2.codegen.translation</span> <span class="k">import</span> <span class="n">make_statements</span>
<span class="kn">from</span> <span class="nn">brian2.core.clocks</span> <span class="k">import</span> <span class="n">Clock</span><span class="p">,</span> <span class="n">defaultclock</span>
<span class="kn">from</span> <span class="nn">brian2.core.namespace</span> <span class="k">import</span> <span class="n">get_local_namespace</span>
<span class="kn">from</span> <span class="nn">brian2.core.preferences</span> <span class="k">import</span> <span class="n">prefs</span><span class="p">,</span> <span class="n">PreferenceError</span>
<span class="kn">from</span> <span class="nn">brian2.core.variables</span> <span class="k">import</span> <span class="n">ArrayVariable</span><span class="p">,</span> <span class="n">DynamicArrayVariable</span>
<span class="kn">from</span> <span class="nn">brian2.parsing.rendering</span> <span class="k">import</span> <span class="n">CPPNodeRenderer</span>
<span class="kn">from</span> <span class="nn">brian2.devices.device</span> <span class="k">import</span> <span class="n">all_devices</span>
<span class="kn">from</span> <span class="nn">brian2.synapses.synapses</span> <span class="k">import</span> <span class="n">Synapses</span><span class="p">,</span> <span class="n">SynapticPathway</span>
<span class="kn">from</span> <span class="nn">brian2.utils.filetools</span> <span class="k">import</span> <span class="n">copy_directory</span><span class="p">,</span> <span class="n">ensure_directory</span>
<span class="kn">from</span> <span class="nn">brian2.utils.stringtools</span> <span class="k">import</span> <span class="n">get_identifiers</span>
<span class="kn">from</span> <span class="nn">brian2.codegen.generators.cpp_generator</span> <span class="k">import</span> <span class="n">c_data_type</span>
<span class="kn">from</span> <span class="nn">brian2.utils.logger</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">brian2.units</span> <span class="k">import</span> <span class="n">second</span>

<span class="kn">from</span> <span class="nn">brian2.devices.cpp_standalone.device</span> <span class="k">import</span> <span class="n">CPPWriter</span><span class="p">,</span> <span class="n">CPPStandaloneDevice</span>
<span class="kn">from</span> <span class="nn">brian2.input.spikegeneratorgroup</span> <span class="k">import</span> <span class="n">SpikeGeneratorGroup</span>

<span class="kn">from</span> <span class="nn">brian2cuda.utils.stringtools</span> <span class="k">import</span> <span class="n">replace_floating_point_literals</span>
<span class="kn">from</span> <span class="nn">brian2cuda.utils.gputools</span> <span class="k">import</span> <span class="n">select_gpu</span><span class="p">,</span> <span class="n">get_nvcc_path</span>

<span class="kn">from</span> <span class="nn">.codeobject</span> <span class="k">import</span> <span class="n">CUDAStandaloneCodeObject</span><span class="p">,</span> <span class="n">CUDAStandaloneAtomicsCodeObject</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s1">&#39;brian2.devices.cuda_standalone&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="CUDAWriter"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAWriter.html#brian2cuda.device.CUDAWriter">[docs]</a><span class="k">class</span> <span class="nc">CUDAWriter</span><span class="p">(</span><span class="n">CPPWriter</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span> <span class="o">=</span> <span class="n">project_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_files</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CUDAWriter.write"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAWriter.html#brian2cuda.device.CUDAWriter.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">diagnostic</span><span class="p">(</span><span class="s1">&#39;Writing file </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.cu&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.cpp&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.*&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;cu&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="o">.</span><span class="n">cu_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="o">.</span><span class="n">h_file</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">fullfilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fullfilename</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">open</span><span class="p">(</span><span class="n">fullfilename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">==</span><span class="n">contents</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fullfilename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CUDAStandaloneDevice"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice">[docs]</a><span class="k">class</span> <span class="nc">CUDAStandaloneDevice</span><span class="p">(</span><span class="n">CPPStandaloneDevice</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The `Device` used for CUDA standalone simulations.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimal_compute_capability</span> <span class="o">=</span> <span class="mf">3.5</span>
        <span class="c1"># only true during first run call (relevant for synaptic pre/post ID deletion)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># list of pre/post ID arrays that are not needed in device memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_pre</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># for each run, store a dictionary of codeobjects using rand, randn, binomial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_objects_per_run</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># and a dictionary with the same across all run calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rand&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;randn&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;rand_or_randn&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;binomial&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="c1"># and collect codeobjects run only once with binomial in separate list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_object_with_binomial_separate_call</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># store gpu_id and compute capability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CUDAStandaloneDevice</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="CUDAStandaloneDevice.get_array_name"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.get_array_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_array_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">access_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a globally unique name for `var`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        access_data : bool, optional</span>
<span class="sd">            For `DynamicArrayVariable` objects, specifying `True` here means the</span>
<span class="sd">            name for the underlying data is returned. If specifying `False`,</span>
<span class="sd">            the name of object itself is returned (e.g. to allow resizing).</span>
<span class="sd">        prefix: {&#39;_ptr&#39;, &#39;dev&#39;, &#39;d&#39;}, optional</span>
<span class="sd">            Prefix for array name. Host pointers to device memory are prefixed</span>
<span class="sd">            with `dev`, device pointers to device memory are prefixed with `d`</span>
<span class="sd">            and pointers used in `scalar_code` and `vector_code` are prefixed</span>
<span class="sd">            with `_ptr` (independent of whether they are used in host or device</span>
<span class="sd">            code). The `_ptr` variables are declared as parameters in the</span>
<span class="sd">            kernel definition (KERNEL_PARAMETERS).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># In single-precision mode we replace dt variables in codeobjects with</span>
        <span class="c1"># a single precision version, for details see #148</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;real_var&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">real_var</span><span class="p">,</span> <span class="n">access_data</span><span class="o">=</span><span class="n">access_data</span><span class="p">,</span>
                                       <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ptr&#39;</span><span class="p">,</span> <span class="s1">&#39;dev&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;`prefix` has to be one of </span><span class="si">{choices}</span><span class="s2"> or `None`, got </span><span class="si">{prefix}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">access_data</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_ptr&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Don&#39;t use `&#39;</span><span class="si">{prefix}</span><span class="s2">&#39;` prefix for a dynamic array object.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">))</span>

        <span class="n">array_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">DynamicArrayVariable</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">access_data</span><span class="p">:</span>
                <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_arrays</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_arrays_2d</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ArrayVariable</span><span class="p">):</span>
            <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">((</span><span class="s1">&#39;Do not have a name for variable of type &#39;</span>
                             <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">array_name</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.code_object_class"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.code_object_class">[docs]</a>    <span class="k">def</span> <span class="nf">code_object_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">codeobj_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fallback_pref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return `CodeObject` class (either `CUDAStandaloneCodeObject` class or input)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        codeobj_class : a `CodeObject` class, optional</span>
<span class="sd">            If this is keyword is set to None or no arguments are given, this method will return</span>
<span class="sd">            the default (`CUDAStandaloneCodeObject` class).</span>
<span class="sd">        fallback_pref : str, optional</span>
<span class="sd">            For the cuda_standalone device this option is ignored.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        codeobj_class : class</span>
<span class="sd">            The `CodeObject` class that should be used</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Ignore the requested pref (used for optimization in runtime)</span>
        <span class="k">if</span> <span class="n">codeobj_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CUDAStandaloneCodeObject</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">codeobj_class</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.get_array_read_write"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.get_array_read_write">[docs]</a>    <span class="k">def</span> <span class="nf">get_array_read_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abstract_code</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
        <span class="c1">##################################################################</span>
        <span class="c1"># This code is copied from CodeGenerator.translate() and</span>
        <span class="c1"># CodeGenerator.array_read_write() and should give us a set of</span>
        <span class="c1"># variables to which will be written or from which will be read in</span>
        <span class="c1"># `vector_code`</span>
        <span class="c1">##################################################################</span>
        <span class="n">vector_statements</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ac_name</span><span class="p">,</span> <span class="n">ac_code</span> <span class="ow">in</span> <span class="n">abstract_code</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">statements</span> <span class="o">=</span> <span class="n">make_statements</span><span class="p">(</span><span class="n">ac_code</span><span class="p">,</span>
                                         <span class="n">variables</span><span class="p">,</span>
                                         <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">],</span>
                                         <span class="n">optimise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">blockname</span><span class="o">=</span><span class="n">ac_name</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">vector_statements</span><span class="p">[</span><span class="n">ac_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">statements</span>
        <span class="n">read</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">write</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">statements</span> <span class="ow">in</span> <span class="n">vector_statements</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">stmt</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">get_identifiers</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
                <span class="c1"># if the operation is inplace this counts as a read.</span>
                <span class="k">if</span> <span class="n">stmt</span><span class="o">.</span><span class="n">inplace</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
                <span class="n">read</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                <span class="n">write</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
        <span class="n">read</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varname</span> <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                   <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ArrayVariable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">read</span><span class="p">)</span>
        <span class="n">write</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">varname</span> <span class="k">for</span> <span class="n">varname</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ArrayVariable</span><span class="p">)</span> <span class="ow">and</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">write</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.code_object"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.code_object">[docs]</a>    <span class="k">def</span> <span class="nf">code_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">abstract_code</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span>
                    <span class="n">variable_indices</span><span class="p">,</span> <span class="n">codeobj_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">template_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">override_conditional_write</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span> <span class="ow">and</span> <span class="s1">&#39;dt&#39;</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
            <span class="c1"># In single-precision mode we replace dt variables in codeobjects with</span>
            <span class="c1"># a single precision version, for details see #148</span>
            <span class="n">dt_var</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
            <span class="n">new_dt_var</span> <span class="o">=</span> <span class="n">ArrayVariable</span><span class="p">(</span><span class="n">dt_var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">dt_var</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span>
                                       <span class="n">dt_var</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                       <span class="n">dt_var</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                                       <span class="n">dimensions</span><span class="o">=</span><span class="n">dt_var</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
                                       <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
                                       <span class="n">constant</span><span class="o">=</span><span class="n">dt_var</span><span class="o">.</span><span class="n">constant</span><span class="p">,</span>
                                       <span class="n">scalar</span><span class="o">=</span><span class="n">dt_var</span><span class="o">.</span><span class="n">scalar</span><span class="p">,</span>
                                       <span class="n">read_only</span><span class="o">=</span><span class="n">dt_var</span><span class="o">.</span><span class="n">read_only</span><span class="p">,</span>
                                       <span class="n">dynamic</span><span class="o">=</span><span class="n">dt_var</span><span class="o">.</span><span class="n">dynamic</span><span class="p">,</span>
                                       <span class="n">unique</span><span class="o">=</span><span class="n">dt_var</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
            <span class="n">new_dt_var</span><span class="o">.</span><span class="n">real_var</span> <span class="o">=</span> <span class="n">dt_var</span>
            <span class="n">new_dt_var</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">dt_var</span><span class="o">.</span><span class="n">get_value</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">variables</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dt_var</span>
        <span class="k">if</span> <span class="n">template_kwds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">template_kwds</span><span class="p">)</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s1">&#39;profiled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_profiling</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s1">&#39;bundle_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;devices.cuda_standalone.push_synapse_bundles&quot;</span><span class="p">]</span>
        <span class="n">no_or_const_delay_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="p">(</span><span class="n">SynapticPathway</span><span class="p">,</span> <span class="n">Synapses</span><span class="p">))</span> <span class="ow">and</span> <span class="s2">&quot;delay&quot;</span> <span class="ow">in</span> <span class="n">owner</span><span class="o">.</span><span class="n">variables</span> <span class="ow">and</span> <span class="n">owner</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">scalar</span><span class="p">:</span>
            <span class="c1"># catches Synapses(..., delay=...) syntax, does not catch the case when no delay is specified at all</span>
            <span class="n">no_or_const_delay_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;no_or_const_delay_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_or_const_delay_mode</span>

        <span class="c1"># Check if pre/post IDs are needed per synapse</span>
        <span class="c1"># This is the case  when presynapic/postsynapitc variables are used in synapses code or</span>
        <span class="c1"># if they are used to set synaptic variables after the first run call.</span>
        <span class="c1"># If in at least one `synapses` template for the same Synapses</span>
        <span class="c1"># object or in a `run_regularly` call (creates a `statupdate`) a</span>
        <span class="c1"># pre/post IDs are needed, we don&#39;t delete them. And if a synapses object that is only</span>
        <span class="c1"># run once after the first run call (e.g. syn.w[&#39;i&lt;j&#39;] = ...), we don&#39;t delete either.</span>
        <span class="c1"># If deleted, they will be deleted on the device in `run_lines` (see below)</span>
        <span class="n">synapses_object_every_tick</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">synapses_object_single_tick_after_run</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">Synapses</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;synapses&#39;</span><span class="p">,</span> <span class="s1">&#39;stateupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;summed_variable&#39;</span><span class="p">]:</span>
                <span class="n">synapses_object_every_tick</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_run</span> <span class="ow">and</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;group_variable_set_conditional&#39;</span><span class="p">,</span> <span class="s1">&#39;group_variable_set&#39;</span><span class="p">]:</span>
                <span class="n">synapses_object_single_tick_after_run</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">synapses_object_every_tick</span> <span class="ow">or</span> <span class="n">synapses_object_single_tick_after_run</span><span class="p">:</span>
            <span class="n">read</span><span class="p">,</span> <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_read_write</span><span class="p">(</span><span class="n">abstract_code</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
            <span class="n">read_write</span> <span class="o">=</span> <span class="n">read</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">write</span><span class="p">)</span>
            <span class="n">synaptic_pre_array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">owner</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;_synaptic_pre&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">synaptic_post_array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">owner</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;_synaptic_post&#39;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">synaptic_pre_array_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_pre</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_pre</span><span class="p">[</span><span class="n">synaptic_pre_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">synaptic_post_array_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span><span class="p">[</span><span class="n">synaptic_post_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&#39;devices.cuda_standalone.no_</span><span class="si">{prepost}</span><span class="s2">_references&#39; &quot;</span>
                         <span class="s2">&quot;was set to True, but </span><span class="si">{prepost}</span><span class="s2">synaptic index is &quot;</span>
                         <span class="s2">&quot;needed for variable </span><span class="si">{varname}</span><span class="s2"> in </span><span class="si">{owner.name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Check for all variable that are read or written to if they are</span>
            <span class="c1"># i/j or their indices are pre/post</span>
            <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">read_write</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">variable_indices</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_presynaptic_idx&#39;</span> <span class="ow">or</span> <span class="n">varname</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_pre</span><span class="p">[</span><span class="n">synaptic_pre_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.no_pre_references&#39;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="n">PreferenceError</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prepost</span><span class="o">=</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span>
                                                                   <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
                                                                   <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_postsynaptic_idx&#39;</span> <span class="ow">or</span> <span class="n">varname</span> <span class="o">==</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span><span class="p">[</span><span class="n">synaptic_post_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.no_post_references&#39;</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="n">PreferenceError</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prepost</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span>
                                                                   <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
                                                                   <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">))</span>
            <span class="c1"># Summed variables need the indices of their target variable, which</span>
            <span class="c1"># are not in the read_write set.</span>
            <span class="k">if</span> <span class="n">template_name</span> <span class="o">==</span> <span class="s1">&#39;summed_variable&#39;</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">template_kwds</span><span class="p">[</span><span class="s1">&#39;_index_var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">varname</span> <span class="o">=</span> <span class="n">template_kwds</span><span class="p">[</span><span class="s1">&#39;_target_var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_synaptic_pre&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_pre</span><span class="p">[</span><span class="n">synaptic_pre_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.no_pre_references&#39;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="n">PreferenceError</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prepost</span><span class="o">=</span><span class="s1">&#39;pre&#39;</span><span class="p">,</span>
                                                               <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
                                                               <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_synaptic_post&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span><span class="p">[</span><span class="n">synaptic_post_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.no_post_references&#39;</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="n">PreferenceError</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prepost</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span>
                                                               <span class="n">varname</span><span class="o">=</span><span class="n">varname</span><span class="p">,</span>
                                                               <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_syaptic_post&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span><span class="p">[</span><span class="n">synaptic_post_array_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">template_name</span> <span class="o">==</span> <span class="s2">&quot;synapses&quot;</span><span class="p">:</span>
            <span class="n">prepost</span> <span class="o">=</span> <span class="n">template_kwds</span><span class="p">[</span><span class="s1">&#39;pathway&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prepost</span>
            <span class="n">synaptic_effects</span> <span class="o">=</span> <span class="s2">&quot;synapse&quot;</span>
            <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">write</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">variable_indices</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">prepost</span> <span class="o">==</span> <span class="s1">&#39;pre&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_postsynaptic_idx&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prepost</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_presynaptic_idx&#39;</span><span class="p">):</span>
                        <span class="c1"># The SynapticPathways &#39;target&#39; group variables are modified</span>
                        <span class="k">if</span> <span class="n">synaptic_effects</span> <span class="o">==</span> <span class="s2">&quot;synapse&quot;</span><span class="p">:</span>
                            <span class="n">synaptic_effects</span> <span class="o">=</span> <span class="s2">&quot;target&quot;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">prepost</span> <span class="o">==</span> <span class="s1">&#39;pre&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_presynaptic_idx&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prepost</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">==</span> <span class="s1">&#39;_postsynaptic_idx&#39;</span><span class="p">):</span>
                        <span class="c1"># The SynapticPathways &#39;source&#39; group variables are modified</span>
                        <span class="n">synaptic_effects</span> <span class="o">=</span> <span class="s2">&quot;source&quot;</span>
            <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;synaptic_effects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">synaptic_effects</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;debug syn effect mode &#39;</span><span class="p">,</span> <span class="n">synaptic_effects</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Synaptic effects of Synapses object </span><span class="si">{syn}</span><span class="s2"> modify </span><span class="si">{mod}</span><span class="s2"> group variables.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">syn</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="n">synaptic_effects</span><span class="p">))</span>
            <span class="c1"># use atomics if possible (except for `synapses` mode, where we cann parallelise without)</span>
            <span class="c1"># TODO: this overwrites if somebody sets a codeobject in the Synapses(..., codeobj_class=...)</span>
            <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.use_atomics&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">synaptic_effects</span> <span class="o">!=</span> <span class="s1">&#39;synapses&#39;</span><span class="p">:</span>
                <span class="n">codeobj_class</span> <span class="o">=</span> <span class="n">CUDAStandaloneAtomicsCodeObject</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using atomics in synaptic effect application of &quot;</span>
                             <span class="s2">&quot;Synapses object </span><span class="si">{syn}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">syn</span><span class="o">=</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;synapses_create_generator&quot;</span><span class="p">,</span> <span class="s2">&quot;synapses_create_array&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">owner</span><span class="o">.</span><span class="n">multisynaptic_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;multisynaptic_idx_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">owner</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">owner</span><span class="o">.</span><span class="n">multisynaptic_index</span><span class="p">]</span>
            <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;no_pre_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;no_post_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.no_pre_references&#39;</span><span class="p">]:</span>
                <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;no_pre_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.no_post_references&#39;</span><span class="p">]:</span>
                <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;no_post_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;launch_bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;devices.cuda_standalone.launch_bounds&quot;</span><span class="p">]</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;sm_multiplier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;devices.cuda_standalone.SM_multiplier&quot;</span><span class="p">]</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;syn_launch_bounds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;devices.cuda_standalone.syn_launch_bounds&quot;</span><span class="p">]</span>
        <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;calc_occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;devices.cuda_standalone.calc_occupancy&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">template_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="s2">&quot;spikegenerator&quot;</span><span class="p">]:</span>
            <span class="n">template_kwds</span><span class="p">[</span><span class="s2">&quot;extra_threshold_kernel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefs</span><span class="p">[</span><span class="s2">&quot;devices.cuda_standalone.extra_threshold_kernel&quot;</span><span class="p">]</span>
        <span class="n">codeobj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CUDAStandaloneDevice</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">code_object</span><span class="p">(</span><span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">abstract_code</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span>
                                                               <span class="n">template_name</span><span class="p">,</span> <span class="n">variable_indices</span><span class="p">,</span>
                                                               <span class="n">codeobj_class</span><span class="o">=</span><span class="n">codeobj_class</span><span class="p">,</span>
                                                               <span class="n">template_kwds</span><span class="o">=</span><span class="n">template_kwds</span><span class="p">,</span>
                                                               <span class="n">override_conditional_write</span><span class="o">=</span><span class="n">override_conditional_write</span><span class="p">,</span>
                                                               <span class="p">)</span>
        <span class="k">return</span> <span class="n">codeobj</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.check_openmp_compatible"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.check_openmp_compatible">[docs]</a>    <span class="k">def</span> <span class="nf">check_openmp_compatible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb_threads</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nb_threads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Using OpenMP in an CUDA standalone project is not supported&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_objects_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_objects_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_objects_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">arange_arrays</span><span class="p">,</span> <span class="n">synapses</span><span class="p">,</span> <span class="n">static_array_specs</span><span class="p">,</span> <span class="n">networks</span><span class="p">):</span>
        <span class="n">sm_multiplier</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">cuda_standalone</span><span class="o">.</span><span class="n">SM_multiplier</span>
        <span class="n">num_parallel_blocks</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">cuda_standalone</span><span class="o">.</span><span class="n">parallel_blocks</span>
        <span class="n">curand_generator_type</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">cuda_standalone</span><span class="o">.</span><span class="n">random_number_generator_type</span>
        <span class="n">curand_generator_ordering</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">cuda_standalone</span><span class="o">.</span><span class="n">random_number_generator_ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eventspace_arrays</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spikegenerator_eventspaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;space&#39;</span><span class="p">):</span>  <span class="c1"># get all eventspace variables</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eventspace_arrays</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">varname</span>
                <span class="c1">#if hasattr(var, &#39;owner&#39;) and isinstance(v.owner, Clock):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">SpikeGeneratorGroup</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spikegenerator_eventspaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eventspace_arrays</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="n">multisyn_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">synapses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">syn</span><span class="o">.</span><span class="n">multisynaptic_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">multisyn_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syn</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">syn</span><span class="o">.</span><span class="n">multisynaptic_index</span><span class="p">])</span>
        <span class="n">arr_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">array_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">,</span>
                        <span class="n">dynamic_array_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_arrays</span><span class="p">,</span>
                        <span class="n">dynamic_array_2d_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dynamic_arrays_2d</span><span class="p">,</span>
                        <span class="n">zero_arrays</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_arrays</span><span class="p">,</span>
                        <span class="n">arange_arrays</span><span class="o">=</span><span class="n">arange_arrays</span><span class="p">,</span>
                        <span class="n">synapses</span><span class="o">=</span><span class="n">synapses</span><span class="p">,</span>
                        <span class="n">clocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clocks</span><span class="p">,</span>
                        <span class="n">static_array_specs</span><span class="o">=</span><span class="n">static_array_specs</span><span class="p">,</span>
                        <span class="n">networks</span><span class="o">=</span><span class="n">networks</span><span class="p">,</span>
                        <span class="n">code_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                        <span class="n">get_array_filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array_filename</span><span class="p">,</span>
                        <span class="n">all_codeobj_with_rand</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;rand&#39;</span><span class="p">],</span>
                        <span class="n">all_codeobj_with_randn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;randn&#39;</span><span class="p">],</span>
                        <span class="n">sm_multiplier</span><span class="o">=</span><span class="n">sm_multiplier</span><span class="p">,</span>
                        <span class="n">num_parallel_blocks</span><span class="o">=</span><span class="n">num_parallel_blocks</span><span class="p">,</span>
                        <span class="n">curand_generator_type</span><span class="o">=</span><span class="n">curand_generator_type</span><span class="p">,</span>
                        <span class="n">curand_generator_ordering</span><span class="o">=</span><span class="n">curand_generator_ordering</span><span class="p">,</span>
                        <span class="n">curand_float_type</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span>
                        <span class="n">eventspace_arrays</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eventspace_arrays</span><span class="p">,</span>
                        <span class="n">spikegenerator_eventspaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spikegenerator_eventspaces</span><span class="p">,</span>
                        <span class="n">multisynaptic_idx_vars</span><span class="o">=</span><span class="n">multisyn_vars</span><span class="p">,</span>
                        <span class="n">profiled_codeobjects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profiled_codeobjects</span><span class="p">)</span>
        <span class="c1"># Reinsert deleted entries, in case we use self.arrays later? maybe unnecassary...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eventspace_arrays</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;objects.*&#39;</span><span class="p">,</span> <span class="n">arr_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_main_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_main_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_main_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">main_includes</span><span class="p">):</span>
        <span class="n">main_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">procedures</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">main_lines</span><span class="p">)]</span>
        <span class="n">runfuncs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">run_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_queue</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;run_code_object&#39;</span><span class="p">:</span>
                <span class="n">codeobj</span><span class="p">,</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">codeobj</span><span class="o">.</span><span class="n">runs_every_tick</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># need to check for rand/randn/binomial for objects only run</span>
                <span class="c1"># once, stored in `code_object.rand(n)_calls`.</span>
                <span class="n">uses_binomial</span> <span class="o">=</span> <span class="n">check_codeobj_for_rng</span><span class="p">(</span><span class="n">codeobj</span><span class="p">,</span> <span class="n">check_binomial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uses_binomial</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">code_object_with_binomial_separate_call</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codeobj</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">Synapses</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;group_variable_set_conditional&#39;</span><span class="p">,</span> <span class="s1">&#39;group_variable_set&#39;</span><span class="p">]:</span>
                        <span class="c1"># At curand state initalization, synapses are not generated yet.</span>
                        <span class="c1"># For codeobjects run every tick, this happens in the init() of</span>
                        <span class="c1"># tha random number buffer called at first clock cycle of the network</span>
                        <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;random_number_buffer.ensure_enough_curand_states();&#39;</span><span class="p">)</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_run_</span><span class="si">%s</span><span class="s1">();&#39;</span> <span class="o">%</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;run_network&#39;</span><span class="p">:</span>
                <span class="n">net</span><span class="p">,</span> <span class="n">netcode</span> <span class="o">=</span> <span class="n">args</span>
                <span class="k">if</span> <span class="n">run_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># These lines delete `i`/`j` variables stored per synapse. They need to be called after</span>
                    <span class="c1"># synapses_initialise_queue codeobjects, therefore just before the network creation, so I</span>
                    <span class="c1"># put them here</span>
                    <span class="k">for</span> <span class="n">arrname</span><span class="p">,</span> <span class="n">boolean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_pre</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span>
                            <span class="n">lines</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            dev</span><span class="si">{synaptic_pre}</span><span class="s1">.clear();</span>
<span class="s1">                            dev</span><span class="si">{synaptic_pre}</span><span class="s1">.shrink_to_fit();</span>
<span class="s1">                            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">synaptic_pre</span><span class="o">=</span><span class="n">arrname</span><span class="p">)</span>
                            <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">arrname</span><span class="p">,</span> <span class="n">boolean</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_synaptic_post</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span>
                            <span class="n">lines</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            dev</span><span class="si">{synaptic_post}</span><span class="s1">.clear();</span>
<span class="s1">                            dev</span><span class="si">{synaptic_post}</span><span class="s1">.shrink_to_fit();</span>
<span class="s1">                            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">synaptic_post</span><span class="o">=</span><span class="n">arrname</span><span class="p">)</span>
                            <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">netcode</span><span class="p">)</span>
                <span class="n">run_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;set_by_constant&#39;</span><span class="p">:</span>
                <span class="n">arrayname</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">is_dynamic</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">size_str</span> <span class="o">=</span> <span class="n">arrayname</span> <span class="o">+</span> <span class="s2">&quot;.size()&quot;</span> <span class="k">if</span> <span class="n">is_dynamic</span> <span class="k">else</span> <span class="s2">&quot;_num_&quot;</span> <span class="o">+</span> <span class="n">arrayname</span>
                <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                for(int i=0; i&lt;</span><span class="si">{size_str}</span><span class="s1">; i++)</span>
<span class="s1">                {{</span>
<span class="s1">                    </span><span class="si">{arrayname}</span><span class="s1">[i] = </span><span class="si">{value}</span><span class="s1">;</span>
<span class="s1">                }}</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">,</span> <span class="n">size_str</span><span class="o">=</span><span class="n">size_str</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">=</span><span class="n">CPPNodeRenderer</span><span class="p">()</span><span class="o">.</span><span class="n">render_expr</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="n">pointer_arrayname</span> <span class="o">=</span> <span class="s2">&quot;dev</span><span class="si">{arrayname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arrayname</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;space&#39;</span><span class="p">):</span>  <span class="c1"># eventspace</span>
                    <span class="n">pointer_arrayname</span> <span class="o">+=</span> <span class="s1">&#39;[current_idx</span><span class="si">{arrayname}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_dynamic</span><span class="p">:</span>
                    <span class="n">pointer_arrayname</span> <span class="o">=</span> <span class="s2">&quot;thrust::raw_pointer_cast(&amp;dev</span><span class="si">{arrayname}</span><span class="s2">[0])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                CUDA_SAFE_CALL(</span>
<span class="s1">                        cudaMemcpy(</span><span class="si">{pointer_arrayname}</span><span class="s1">, &amp;</span><span class="si">{arrayname}</span><span class="s1">[0],</span>
<span class="s1">                                sizeof(</span><span class="si">{arrayname}</span><span class="s1">[0])*</span><span class="si">{size_str}</span><span class="s1">, cudaMemcpyHostToDevice)</span>
<span class="s1">                        );</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">,</span> <span class="n">size_str</span><span class="o">=</span><span class="n">size_str</span><span class="p">,</span> <span class="n">pointer_arrayname</span><span class="o">=</span><span class="n">pointer_arrayname</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">=</span><span class="n">CPPNodeRenderer</span><span class="p">()</span><span class="o">.</span><span class="n">render_expr</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">line</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;set_by_single_value&#39;</span><span class="p">:</span>
                <span class="n">arrayname</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">pointer_arrayname</span> <span class="o">=</span> <span class="s2">&quot;dev</span><span class="si">{arrayname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arrayname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_arrays</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">pointer_arrayname</span> <span class="o">=</span> <span class="s2">&quot;thrust::raw_pointer_cast(&amp;dev</span><span class="si">{arrayname}</span><span class="s2">[0])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                </span><span class="si">{arrayname}</span><span class="s1">[</span><span class="si">{item}</span><span class="s1">] = </span><span class="si">{value}</span><span class="s1">;</span>
<span class="s1">                CUDA_SAFE_CALL(</span>
<span class="s1">                        cudaMemcpy(&amp;</span><span class="si">{pointer_arrayname}</span><span class="s1">[</span><span class="si">{item}</span><span class="s1">], &amp;</span><span class="si">{arrayname}</span><span class="s1">[</span><span class="si">{item}</span><span class="s1">],</span>
<span class="s1">                                sizeof(</span><span class="si">{arrayname}</span><span class="s1">[0]), cudaMemcpyHostToDevice)</span>
<span class="s1">                        );</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pointer_arrayname</span><span class="o">=</span><span class="n">pointer_arrayname</span><span class="p">,</span> <span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">code</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;set_by_array&#39;</span><span class="p">:</span>
                <span class="n">arrayname</span><span class="p">,</span> <span class="n">staticarrayname</span><span class="p">,</span> <span class="n">is_dynamic</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;_num_&quot;</span> <span class="o">+</span> <span class="n">arrayname</span>
                <span class="k">if</span> <span class="n">is_dynamic</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">arrayname</span> <span class="o">+</span> <span class="s2">&quot;.size()&quot;</span>
                <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                for(int i=0; i&lt;_num_</span><span class="si">{staticarrayname}</span><span class="s1">; i++)</span>
<span class="s1">                {{</span>
<span class="s1">                    </span><span class="si">{arrayname}</span><span class="s1">[i] = </span><span class="si">{staticarrayname}</span><span class="s1">[i];</span>
<span class="s1">                }}</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">,</span> <span class="n">staticarrayname</span><span class="o">=</span><span class="n">staticarrayname</span><span class="p">,</span> <span class="n">size_str</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                <span class="n">pointer_arrayname</span> <span class="o">=</span> <span class="s2">&quot;dev</span><span class="si">{arrayname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arrayname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_arrays</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">pointer_arrayname</span> <span class="o">=</span> <span class="s2">&quot;thrust::raw_pointer_cast(&amp;dev</span><span class="si">{arrayname}</span><span class="s2">[0])&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                CUDA_SAFE_CALL(</span>
<span class="s1">                        cudaMemcpy(</span><span class="si">{pointer_arrayname}</span><span class="s1">, &amp;</span><span class="si">{arrayname}</span><span class="s1">[0],</span>
<span class="s1">                                sizeof(</span><span class="si">{arrayname}</span><span class="s1">[0])*</span><span class="si">{size_str}</span><span class="s1">, cudaMemcpyHostToDevice)</span>
<span class="s1">                        );</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pointer_arrayname</span><span class="o">=</span><span class="n">pointer_arrayname</span><span class="p">,</span> <span class="n">staticarrayname</span><span class="o">=</span><span class="n">staticarrayname</span><span class="p">,</span> <span class="n">size_str</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">)</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">line</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;set_array_by_array&#39;</span><span class="p">:</span>
                <span class="n">arrayname</span><span class="p">,</span> <span class="n">staticarrayname_index</span><span class="p">,</span> <span class="n">staticarrayname_value</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                for(int i=0; i&lt;_num_</span><span class="si">{staticarrayname_index}</span><span class="s1">; i++)</span>
<span class="s1">                {{</span>
<span class="s1">                    </span><span class="si">{arrayname}</span><span class="s1">[</span><span class="si">{staticarrayname_index}</span><span class="s1">[i]] = </span><span class="si">{staticarrayname_value}</span><span class="s1">[i];</span>
<span class="s1">                }}</span>
<span class="s1">                CUDA_SAFE_CALL(</span>
<span class="s1">                        cudaMemcpy(dev</span><span class="si">{arrayname}</span><span class="s1">, &amp;</span><span class="si">{arrayname}</span><span class="s1">[0],</span>
<span class="s1">                                sizeof(</span><span class="si">{arrayname}</span><span class="s1">[0])*_num_</span><span class="si">{arrayname}</span><span class="s1">, cudaMemcpyHostToDevice)</span>
<span class="s1">                        );</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">,</span> <span class="n">staticarrayname_index</span><span class="o">=</span><span class="n">staticarrayname_index</span><span class="p">,</span>
                           <span class="n">staticarrayname_value</span><span class="o">=</span><span class="n">staticarrayname_value</span><span class="p">)</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;resize_array&#39;</span><span class="p">:</span>
                <span class="n">array_name</span><span class="p">,</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    </span><span class="si">{array_name}</span><span class="s1">.resize(</span><span class="si">{new_size}</span><span class="s1">);</span>
<span class="s1">                    THRUST_CHECK_ERROR(dev</span><span class="si">{array_name}</span><span class="s1">.resize(</span><span class="si">{new_size}</span><span class="s1">));</span>
<span class="s1">                &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array_name</span><span class="o">=</span><span class="n">array_name</span><span class="p">,</span> <span class="n">new_size</span><span class="o">=</span><span class="n">new_size</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;insert_code&#39;</span><span class="p">:</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;start_run_func&#39;</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">include_in_parent</span> <span class="o">=</span> <span class="n">args</span>
                <span class="k">if</span> <span class="n">include_in_parent</span><span class="p">:</span>
                    <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">();&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">main_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">procedures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">main_lines</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;end_run_func&#39;</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">include_in_parent</span> <span class="o">=</span> <span class="n">args</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">main_lines</span> <span class="o">=</span> <span class="n">procedures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">runfuncs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_lines</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">main_lines</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">func</span><span class="o">==</span><span class="s1">&#39;seed&#39;</span><span class="p">:</span>
                <span class="n">seed</span> <span class="o">=</span> <span class="n">args</span>
                <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># draw random seed in range of possible uint64 numbers</span>
                    <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;random_number_buffer.set_seed(</span><span class="si">{seed!r}</span><span class="s1">ULL);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Unknown main queue function type &quot;</span><span class="o">+</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># Store the GPU ID and it&#39;s compute capability. The latter can be overwritten in</span>
        <span class="c1"># self.generate_makefile() via preferces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gpu_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="o">=</span> <span class="n">select_gpu</span><span class="p">()</span>

        <span class="c1"># generate the finalisations</span>
        <span class="k">for</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="s1">&#39;main_finalise&#39;</span><span class="p">):</span>
                <span class="n">main_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">main_finalise</span><span class="p">)</span>

        <span class="n">main_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                           <span class="n">gpu_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gpu_id</span><span class="p">,</span>
                                                           <span class="n">main_lines</span><span class="o">=</span><span class="n">main_lines</span><span class="p">,</span>
                                                           <span class="n">code_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                                           <span class="n">report_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">report_func</span><span class="p">,</span>
                                                           <span class="n">dt</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">defaultclock</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span>
                                                           <span class="n">additional_headers</span><span class="o">=</span><span class="n">main_includes</span><span class="p">,</span>
                                                           <span class="n">gpu_heap_size</span><span class="o">=</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;devices.cuda_standalone.cuda_backend.gpu_heap_size&#39;</span><span class="p">]</span>
                                                          <span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;main.cu&#39;</span><span class="p">,</span> <span class="n">main_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_codeobj_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_codeobj_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_codeobj_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="n">code_object_defs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">host_parameters</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">kernel_parameters</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">kernel_constants</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="c1"># Generate data for non-constant values</span>
        <span class="k">for</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">code_object_defs_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">host_parameters_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kernel_parameters_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">kernel_constants_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">additional_code</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">number_elements</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">codeobj</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="s1">&#39;_N&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">_N</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">number_elements</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">_N</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_elements</span> <span class="o">=</span> <span class="s2">&quot;_N&quot;</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;dt&#39;</span> <span class="ow">and</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
                    <span class="c1"># use the double-precision array versions for dt as kernel arguments</span>
                    <span class="c1"># they are cast to single-precision scalar dt in scalar_code</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">real_var</span>

                <span class="c1"># code objects which only run once</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rand&quot;</span><span class="p">,</span> <span class="s2">&quot;randn&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">runs_every_tick</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">!=</span> <span class="s2">&quot;synapses_create_generator&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;randn&quot;</span><span class="p">:</span>
                        <span class="n">code_snippet</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            //genenerate an array of random numbers on the device</span>
<span class="s1">                            </span><span class="si">{dtype}</span><span class="s1">* dev_array_randn;</span>
<span class="s1">                            CUDA_SAFE_CALL(</span>
<span class="s1">                                    cudaMalloc((void**)&amp;dev_array_randn, sizeof(</span><span class="si">{dtype}</span><span class="s1">)*</span><span class="si">{number_elements}</span><span class="s1">*</span><span class="si">{codeobj.randn_calls}</span><span class="s1">)</span>
<span class="s1">                                    );</span>
<span class="s1">                            curandGenerateNormal</span><span class="si">{curand_suffix}</span><span class="s1">(curand_generator, dev_array_randn, </span><span class="si">{number_elements}</span><span class="s1">*</span><span class="si">{codeobj.randn_calls}</span><span class="s1">, 0, 1);</span>
<span class="s1">                            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_elements</span><span class="o">=</span><span class="n">number_elements</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">=</span><span class="n">codeobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span>
                                       <span class="n">curand_suffix</span><span class="o">=</span><span class="s1">&#39;Double&#39;</span> <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">additional_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code_snippet</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{dtype}</span><span class="s2">* _ptr_array_</span><span class="si">{name}</span><span class="s2">_randn&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dev_array_randn&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;rand&quot;</span><span class="p">:</span>
                        <span class="n">code_snippet</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                            //genenerate an array of random numbers on the device</span>
<span class="s1">                            </span><span class="si">{dtype}</span><span class="s1">* dev_array_rand;</span>
<span class="s1">                            CUDA_SAFE_CALL(</span>
<span class="s1">                                    cudaMalloc((void**)&amp;dev_array_rand, sizeof(</span><span class="si">{dtype}</span><span class="s1">)*</span><span class="si">{number_elements}</span><span class="s1">*</span><span class="si">{codeobj.rand_calls}</span><span class="s1">)</span>
<span class="s1">                                    );</span>
<span class="s1">                            curandGenerateUniform</span><span class="si">{curand_suffix}</span><span class="s1">(curand_generator, dev_array_rand, </span><span class="si">{number_elements}</span><span class="s1">*</span><span class="si">{codeobj.rand_calls}</span><span class="s1">);</span>
<span class="s1">                            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">number_elements</span><span class="o">=</span><span class="n">number_elements</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">=</span><span class="n">codeobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span>
                                       <span class="n">curand_suffix</span><span class="o">=</span><span class="s1">&#39;Double&#39;</span> <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">additional_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code_snippet</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{dtype}</span><span class="s2">* _ptr_array_</span><span class="si">{name}</span><span class="s2">_rand&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dev_array_rand&quot;</span><span class="p">)</span>
                <span class="c1"># Clock variables (t, dt, timestep)</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;owner&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">Clock</span><span class="p">):</span>
                    <span class="c1"># Clocks only run on the host and the corresponding device variables are copied</span>
                    <span class="c1"># to the device only once in the beginning and in the end of a simulation.</span>
                    <span class="c1"># Therefore, we pass clock variables (t, dt, timestep) by value as kernel</span>
                    <span class="c1"># parameters whenever they are needed on the device. These values are translated</span>
                    <span class="c1"># into pointers in CUDACodeGenerator.determine_keywords(), such that they can be</span>
                    <span class="c1"># used in scalar/vector code.</span>
                    <span class="n">arrayname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">c_data_type</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{arrayname}</span><span class="s2">[0]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">))</span>
                    <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;const </span><span class="si">{dtype}</span><span class="s2"> _value</span><span class="si">{arrayname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">arrayname</span><span class="o">=</span><span class="n">arrayname</span><span class="p">))</span>
                <span class="c1"># ArrayVariables (dynamic and not)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ArrayVariable</span><span class="p">):</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;dev&#39;</span>
                    <span class="c1"># These codeobjects run on the host</span>
                    <span class="n">host_codeobjects</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;synapses_create_generator&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;synapses_create_array&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;synapses_initialise_queue&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">in</span> <span class="n">host_codeobjects</span><span class="p">:</span>
                        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dyn_array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span>
                                                             <span class="n">access_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                             <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span>
                                                         <span class="n">access_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                         <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">ptr_array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span>
                                                             <span class="n">access_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                             <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;_ptr&#39;</span><span class="p">)</span>
                        <span class="n">dtype</span> <span class="o">=</span> <span class="n">c_data_type</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">DynamicArrayVariable</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{dtype}</span><span class="s1">* const </span><span class="si">{array_name}</span><span class="s1"> = thrust::raw_pointer_cast(&amp;</span><span class="si">{dyn_array_name}</span><span class="s1">[0]);&#39;</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                                                   <span class="n">array_name</span><span class="o">=</span><span class="n">array_name</span><span class="p">,</span>
                                                   <span class="n">dyn_array_name</span><span class="o">=</span><span class="n">dyn_array_name</span><span class="p">)</span>
                                <span class="n">code_object_defs_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;const int _num</span><span class="si">{k}</span><span class="s1"> = </span><span class="si">{dyn_array_name}</span><span class="s1">.size();&#39;</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">dyn_array_name</span><span class="o">=</span><span class="n">dyn_array_name</span><span class="p">)</span>
                                <span class="n">code_object_defs_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                                <span class="c1"># These lines are used to define the kernel call parameters, that</span>
                                <span class="c1"># means only for codeobjects running on the device. The array names</span>
                                <span class="c1"># always have a `_dev` prefix.</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{array_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array_name</span><span class="o">=</span><span class="n">array_name</span><span class="p">)</span>
                                <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;_num</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>

                                <span class="c1"># These lines declare kernel parameters as the `_ptr` variables that</span>
                                <span class="c1"># are used in `scalar_code` and `vector_code`.</span>
                                <span class="c1"># TODO: here we should add const / __restrict and other optimizations</span>
                                <span class="c1">#       for variables that are e.g. only read in the kernel</span>
                                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{dtype}</span><span class="s2">* </span><span class="si">{ptr_array_name}</span><span class="s2">&quot;</span>
                                <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                                                                           <span class="n">ptr_array_name</span><span class="o">=</span><span class="n">ptr_array_name</span><span class="p">))</span>

                                <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;const int _num</span><span class="si">{k}</span><span class="s2">&quot;</span>
                                <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>

                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># v is ArrayVariable but not DynamicArrayVariable</span>
                            <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{array_name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">array_name</span><span class="o">=</span><span class="n">array_name</span><span class="p">))</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{dtype}</span><span class="s1">* </span><span class="si">{ptr_array_name}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                                                                      <span class="n">ptr_array_name</span><span class="o">=</span><span class="n">ptr_array_name</span><span class="p">)</span>
                            <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                            <span class="n">code_object_defs_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;const int _num</span><span class="si">{k}</span><span class="s1"> = </span><span class="si">{v.size}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">))</span>
                            <span class="n">kernel_constants_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;const int _num</span><span class="si">{k}</span><span class="s1"> = </span><span class="si">{v.size}</span><span class="s1">;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;space&#39;</span><span class="p">):</span>
                                <span class="n">bare_array_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                <span class="n">idx</span> <span class="o">=</span> <span class="s1">&#39;[current_idx</span><span class="si">{bare_array_name}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bare_array_name</span><span class="o">=</span><span class="n">bare_array_name</span><span class="p">)</span>
                                <span class="n">host_parameters_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">idx</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c1"># This rand stuff got a little messy... we pass a device pointer as kernel variable and have a hash define for rand() -&gt; _ptr_..._rand[]</span>
            <span class="c1"># The device pointer is advanced every clock cycle in rand.cu and reset when the random number buffer is refilled (also in rand.cu)</span>
            <span class="c1"># TODO can we just include this in the k == &#39;rand&#39; test above?</span>
            <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">runs_every_tick</span><span class="p">:</span>
                <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dev_</span><span class="si">{name}</span><span class="s2">_rand&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{dtype}</span><span class="s2">* _ptr_array_</span><span class="si">{name}</span><span class="s2">_rand&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span>
                                                                                <span class="n">name</span><span class="o">=</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">randn_calls</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">runs_every_tick</span><span class="p">:</span>
                <span class="n">host_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dev_</span><span class="si">{name}</span><span class="s2">_randn&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">kernel_parameters_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{dtype}</span><span class="s2">* _ptr_array_</span><span class="si">{name}</span><span class="s2">_randn&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]),</span>
                                                                                <span class="n">name</span><span class="o">=</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="c1"># Sometimes an array is referred to by to different keys in our</span>
            <span class="c1"># dictionary -- make sure to never add a line twice</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code_object_defs_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code_object_defs</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">code_object_defs</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">host_parameters_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">host_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">host_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kernel_parameters_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kernel_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">kernel_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">kernel_constants_lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">kernel_constants</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">kernel_constants</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">additional_code</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code_object_defs</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">code_object_defs</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="c1"># Generate the code objects</span>
        <span class="k">for</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">variables</span>
            <span class="c1"># TODO: fix these freeze/HOST_CONSTANTS hacks somehow - they work but not elegant.</span>
            <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">host_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">host_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>
                <span class="n">kernel_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;int dummy&quot;</span><span class="p">)</span>

            <span class="c1"># HOST_CONSTANTS are equivalent to C++ Standalone&#39;s CONSTANTS</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%HOST_CONSTANTS%&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code_object_defs</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
            <span class="c1"># KERNEL_CONSTANTS are the same for inside device kernels</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%KERNEL_CONSTANTS%&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kernel_constants</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
            <span class="c1"># HOST_PARAMETERS are parameters that device kernels are called with from host code</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%HOST_PARAMETERS%&#39;</span><span class="p">,</span> <span class="s1">&#39;,</span><span class="se">\n\t\t\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">host_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
            <span class="c1"># KERNEL_PARAMETERS are the same names of the same parameters inside the device kernels</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%KERNEL_PARAMETERS%&#39;</span><span class="p">,</span> <span class="s1">&#39;,</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kernel_parameters</span><span class="p">[</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">]))</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%CODEOBJ_NAME%&#39;</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;#include &quot;objects.h&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">code</span>

            <span class="c1"># substitue in generated code double types with float types in</span>
            <span class="c1"># single-precision mode</span>
            <span class="k">if</span> <span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
                <span class="c1"># cast time differences (double) to float in event-drive updates</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="s1">&#39;t - lastupdate&#39;</span>
                <span class="k">if</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s1">&#39;float(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replaced </span><span class="si">{sub}</span><span class="s2"> with float(</span><span class="si">{sub}</span><span class="s2">) in </span><span class="si">{codeobj}</span><span class="s2">&quot;</span>
                                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub</span><span class="o">=</span><span class="n">sub</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">=</span><span class="n">codeobj</span><span class="p">))</span>
                <span class="c1"># replace double-precision floating-point literals with their</span>
                <span class="c1"># single-precision version (e.g. `1.0` -&gt; `1.0f`)</span>
                <span class="n">code</span> <span class="o">=</span> <span class="n">replace_floating_point_literals</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Replaced floating point literals by single &quot;</span>
                             <span class="s2">&quot;precision version (appending `f`) in </span><span class="si">{}</span><span class="s2">.&quot;</span>
                             <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">codeobj</span><span class="p">))</span>

            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;code_objects/&#39;</span><span class="o">+</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.cu&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;code_objects/&#39;</span><span class="o">+</span><span class="n">codeobj</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.h&#39;</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">h_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_rand_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_rand_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_rand_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="n">binomial_codeobjects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">co</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;binomial&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">binomial_codeobjects</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">co</span><span class="o">.</span><span class="n">owner</span><span class="p">,</span> <span class="n">Synapses</span><span class="p">):</span>
                    <span class="c1"># this is the pointer to the synapse object&#39;s N, which is a</span>
                    <span class="c1"># null pointer before synapses are generated and an int ptr</span>
                    <span class="c1"># after synapse generation (used to test if synapses</span>
                    <span class="c1"># already generated or not)</span>
                    <span class="n">test_ptr</span> <span class="o">=</span> <span class="s1">&#39;_array_</span><span class="si">{name}</span><span class="s1">_N&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="n">test_ptr</span> <span class="o">+</span> <span class="s1">&#39;[0]&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">test_ptr</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">_N</span>
                <span class="n">binomial_codeobjects</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;test_ptr&#39;</span><span class="p">:</span> <span class="n">test_ptr</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
        <span class="n">rand_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                           <span class="n">code_objects_per_run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code_objects_per_run</span><span class="p">,</span>
                                                           <span class="n">binomial_codeobjects</span><span class="o">=</span><span class="n">binomial_codeobjects</span><span class="p">,</span>
                                                           <span class="n">number_run_calls</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_objects_per_run</span><span class="p">),</span>
                                                           <span class="n">profiled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_profiling</span><span class="p">,</span>
                                                           <span class="n">curand_float_type</span><span class="o">=</span><span class="n">c_data_type</span><span class="p">(</span><span class="n">prefs</span><span class="p">[</span><span class="s1">&#39;core.default_float_dtype&#39;</span><span class="p">]))</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;rand.*&#39;</span><span class="p">,</span> <span class="n">rand_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.copy_source_files"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.copy_source_files">[docs]</a>    <span class="k">def</span> <span class="nf">copy_source_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="c1"># Copy the brianlibdirectory</span>
        <span class="n">brianlib_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()))[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s1">&#39;brianlib&#39;</span><span class="p">)</span>
        <span class="n">brianlib_files</span> <span class="o">=</span> <span class="n">copy_directory</span><span class="p">(</span><span class="n">brianlib_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s1">&#39;brianlib&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">brianlib_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.cpp&#39;</span><span class="p">):</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">source_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;brianlib/&#39;</span><span class="o">+</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.cu&#39;</span><span class="p">):</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">source_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;brianlib/&#39;</span><span class="o">+</span><span class="n">file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h&#39;</span><span class="p">):</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">header_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;brianlib/&#39;</span><span class="o">+</span><span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_network_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_network_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_network_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="n">maximum_run_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maximum_run_time</span>
        <span class="k">if</span> <span class="n">maximum_run_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maximum_run_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">maximum_run_time</span><span class="p">)</span>
        <span class="n">network_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">network</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                                 <span class="n">maximum_run_time</span><span class="o">=</span><span class="n">maximum_run_time</span><span class="p">,</span>
                                                                 <span class="n">eventspace_arrays</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eventspace_arrays</span><span class="p">,</span>
                                                                 <span class="n">spikegenerator_eventspaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spikegenerator_eventspaces</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;network.*&#39;</span><span class="p">,</span> <span class="n">network_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_synapses_classes_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_synapses_classes_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_synapses_classes_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
        <span class="n">synapses_classes_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">synapses_classes</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;synapses_classes.*&#39;</span><span class="p">,</span> <span class="n">synapses_classes_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_run_source"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_run_source">[docs]</a>    <span class="k">def</span> <span class="nf">generate_run_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">run_includes</span><span class="p">):</span>
        <span class="n">run_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">run_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runfuncs</span><span class="p">,</span>
                                                        <span class="n">code_objects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span>
                                                        <span class="n">additional_headers</span><span class="o">=</span><span class="n">run_includes</span><span class="p">,</span>
                                                        <span class="n">array_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">arrays</span><span class="p">,</span>
                                                        <span class="n">clocks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clocks</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;run.*&#39;</span><span class="p">,</span> <span class="n">run_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.generate_makefile"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.generate_makefile">[docs]</a>    <span class="k">def</span> <span class="nf">generate_makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">cpp_compiler</span><span class="p">,</span> <span class="n">cpp_compiler_flags</span><span class="p">,</span> <span class="n">nb_threads</span><span class="p">,</span> <span class="n">disable_asserts</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">available_gpu_arch_flags</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;--gpu-architecture&#39;</span><span class="p">,</span> <span class="s1">&#39;-arch&#39;</span><span class="p">,</span> <span class="s1">&#39;--gpu-code&#39;</span><span class="p">,</span> <span class="s1">&#39;-code&#39;</span><span class="p">,</span> <span class="s1">&#39;--generate-code&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-gencode&#39;</span>
        <span class="p">)</span>
        <span class="n">nvcc_compiler_flags</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">cuda_standalone</span><span class="o">.</span><span class="n">cuda_backend</span><span class="o">.</span><span class="n">extra_compile_args_nvcc</span>
        <span class="n">gpu_arch_flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">disable_warnings</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">nvcc_compiler_flags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">available_gpu_arch_flags</span><span class="p">):</span>
                <span class="n">gpu_arch_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
                <span class="n">nvcc_compiler_flags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--disable-warnings&#39;</span><span class="p">)):</span>
                <span class="n">disable_warnings</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">nvcc_compiler_flags</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="c1"># Check if compute capability was set manually via preference</span>
        <span class="n">compute_capability_pref</span> <span class="o">=</span> <span class="n">prefs</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">cuda_standalone</span><span class="o">.</span><span class="n">cuda_backend</span><span class="o">.</span><span class="n">compute_capability</span>
        <span class="c1"># If GPU architecture was set via `extra_compile_args_nvcc` and</span>
        <span class="c1"># `compute_capability`, ignore `compute_capability`</span>
        <span class="k">if</span> <span class="n">gpu_arch_flags</span> <span class="ow">and</span> <span class="n">compute_capability_pref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;GPU architecture for compilation was specified via &quot;</span>
                <span class="s2">&quot;`prefs.devices.cuda_standalone.cuda_backend.compute_capability` and &quot;</span>
                <span class="s2">&quot;`prefs.devices.cuda_standalone.cuda_backend.extra_compile_args_nvcc`. &quot;</span>
                <span class="s2">&quot;`prefs.devices.cuda_standalone.cuda_backend.compute_capability` will be ignored. &quot;</span>
                <span class="s2">&quot;To get rid of this warning, set &quot;</span>
                <span class="s2">&quot;`prefs.devices.cuda_standalone.brian_backend.compute_capability` to it&#39;s default &quot;</span>
                <span class="s2">&quot;value `None`&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minimal_compute_capability</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Ignore compute capability of chosen GPU and the one manually set via</span>
            <span class="c1"># `compute_capability` preferences.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># If GPU architecture was set only via `extra_compile_args_nvcc`, use that</span>
        <span class="k">elif</span> <span class="n">gpu_arch_flags</span><span class="p">:</span>
            <span class="c1"># Ignore compute capability of chosen GPU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># If GPU architecture was set only via `compute_capability` prefs, use that</span>
        <span class="k">elif</span> <span class="n">compute_capability_pref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="o">=</span> <span class="n">compute_capability_pref</span>
        <span class="c1"># If compute_capability wasn&#39;t set manually, the one from the chosen GPU is used</span>
        <span class="c1"># (stored in self.compute_capability, see self.generate_main_source())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check if compute capability is supported</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal_compute_capability</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="s2">&quot;Compute capability `</span><span class="si">{}</span><span class="s2">` is not supported. Minimal supported &quot;</span>
                    <span class="s2">&quot;compute capability is `</span><span class="si">{}</span><span class="s2">`.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal_compute_capability</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># If GPU architecture is detected automatically or set via `compute_capability`</span>
        <span class="c1"># prefs, we still need to add it as a compile argument</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gpu_arch_flags</span><span class="p">:</span>
            <span class="c1"># Turn float (3.5) into string (&quot;35&quot;)</span>
            <span class="n">compute_capability_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
            <span class="n">gpu_arch_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-arch=sm_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compute_capability_str</span><span class="p">))</span>

        <span class="c1"># Log compiled GPU architecture</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Compiling device code with manually set architecture flags &quot;</span>
                <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">). Be aware that the minimal supported compute capability is </span><span class="si">{}</span><span class="s2"> &quot;</span>
                <span class="s2">&quot;(we are not checking your compile flags)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">gpu_arch_flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimal_compute_capability</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Compiling device code for compute capability </span><span class="si">{}</span><span class="s2"> (compiler flags: </span><span class="si">{}</span><span class="s2">)&quot;</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_capability</span><span class="p">,</span> <span class="n">gpu_arch_flags</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">nvcc_optimization_flags</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">nvcc_compiler_flags</span><span class="p">)</span>
        <span class="n">gpu_arch_flags</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gpu_arch_flags</span><span class="p">)</span>
        <span class="n">nvcc_path</span> <span class="o">=</span> <span class="n">get_nvcc_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cpp_compiler</span><span class="o">==</span><span class="s1">&#39;msvc&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nb_threads</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">openmp_flag</span> <span class="o">=</span> <span class="s1">&#39;/openmp&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">openmp_flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># Generate the visual studio makefile</span>
            <span class="n">source_bases</span> <span class="o">=</span> <span class="p">[</span><span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.cpp&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">writer</span><span class="o">.</span><span class="n">source_files</span><span class="p">]</span>
            <span class="n">win_makefile_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">win_makefile</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">source_bases</span><span class="o">=</span><span class="n">source_bases</span><span class="p">,</span>
                <span class="n">cpp_compiler_flags</span><span class="o">=</span><span class="n">cpp_compiler_flags</span><span class="p">,</span>
                <span class="n">openmp_flag</span><span class="o">=</span><span class="n">openmp_flag</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;win_makefile&#39;</span><span class="p">,</span> <span class="n">win_makefile_tmp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Generate the makefile</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;nt&#39;</span><span class="p">:</span>
                <span class="n">rm_cmd</span> <span class="o">=</span> <span class="s1">&#39;del *.o /s</span><span class="se">\n\t</span><span class="s1">del main.exe $(DEPS)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rm_cmd</span> <span class="o">=</span> <span class="s1">&#39;rm $(OBJS) $(PROGRAM) $(DEPS)&#39;</span>
            <span class="n">makefile_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_class</span><span class="p">()</span><span class="o">.</span><span class="n">templater</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">source_files</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">source_files</span><span class="p">),</span>
                <span class="n">header_files</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">writer</span><span class="o">.</span><span class="n">header_files</span><span class="p">),</span>
                <span class="n">cpp_compiler_flags</span><span class="o">=</span><span class="n">cpp_compiler_flags</span><span class="p">,</span>
                <span class="n">nvcc_optimization_flags</span><span class="o">=</span><span class="n">nvcc_optimization_flags</span><span class="p">,</span>
                <span class="n">gpu_arch_flags</span><span class="o">=</span><span class="n">gpu_arch_flags</span><span class="p">,</span>
                <span class="n">disable_warnings</span><span class="o">=</span><span class="n">disable_warnings</span><span class="p">,</span>
                <span class="n">disable_asserts</span><span class="o">=</span><span class="n">disable_asserts</span><span class="p">,</span>
                <span class="n">rm_cmd</span><span class="o">=</span><span class="n">rm_cmd</span><span class="p">,</span>
                <span class="n">nvcc_path</span><span class="o">=</span><span class="n">nvcc_path</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;makefile&#39;</span><span class="p">,</span> <span class="n">makefile_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.build"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
              <span class="nb">compile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">with_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disable_asserts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">additional_source_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_header_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">main_includes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_includes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">run_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direct_call</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Build the project</span>

<span class="sd">        TODO: more details</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory : str, optional</span>
<span class="sd">            The output directory to write the project to, any existing files</span>
<span class="sd">            will be overwritten. If the given directory name is ``None``, then</span>
<span class="sd">            a temporary directory will be used (used in the test suite to avoid</span>
<span class="sd">            problems when running several tests in parallel). Defaults to</span>
<span class="sd">            ``&#39;output&#39;``.</span>
<span class="sd">        compile : bool, optional</span>
<span class="sd">            Whether or not to attempt to compile the project. Defaults to</span>
<span class="sd">            ``True``.</span>
<span class="sd">        run : bool, optional</span>
<span class="sd">            Whether or not to attempt to run the built project if it</span>
<span class="sd">            successfully builds. Defaults to ``True``.</span>
<span class="sd">        debug : bool, optional</span>
<span class="sd">            Whether to compile in debug mode. Defaults to ``False``.</span>
<span class="sd">        with_output : bool, optional</span>
<span class="sd">            Whether or not to show the ``stdout`` of the built program when run.</span>
<span class="sd">            Output will be shown in case of compilation or runtime error.</span>
<span class="sd">            Defaults to ``True``.</span>
<span class="sd">        clean : bool, optional</span>
<span class="sd">            Whether or not to clean the project before building. Defaults to</span>
<span class="sd">            ``False``.</span>
<span class="sd">        additional_source_files : list of str, optional</span>
<span class="sd">            A list of additional ``.cu`` files to include in the build.</span>
<span class="sd">        additional_header_files : list of str</span>
<span class="sd">            A list of additional ``.h`` files to include in the build.</span>
<span class="sd">        main_includes : list of str</span>
<span class="sd">            A list of additional header files to include in ``main.cu``.</span>
<span class="sd">        run_includes : list of str</span>
<span class="sd">            A list of additional header files to include in ``run.cu``.</span>
<span class="sd">        direct_call : bool, optional</span>
<span class="sd">            Whether this function was called directly. Is used internally to</span>
<span class="sd">            distinguish an automatic build due to the ``build_on_run`` option</span>
<span class="sd">            from a manual ``device.build`` call.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_on_run</span> <span class="ow">and</span> <span class="n">direct_call</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;You used set_device with build_on_run=True &#39;</span>
                               <span class="s1">&#39;(the default option), which will automatically &#39;</span>
                               <span class="s1">&#39;build the simulation at the first encountered &#39;</span>
                               <span class="s1">&#39;run call - do not call device.build manually &#39;</span>
                               <span class="s1">&#39;in this case. If you want to call it manually, &#39;</span>
                               <span class="s1">&#39;e.g. because you have multiple run calls, use &#39;</span>
                               <span class="s1">&#39;set_device with build_on_run=False.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_been_run</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The network has already been built and run &#39;</span>
                               <span class="s1">&#39;before. To build several simulations in &#39;</span>
                               <span class="s1">&#39;the same script, call &quot;device.reinit()&quot; &#39;</span>
                               <span class="s1">&#39;and &quot;device.activate()&quot;. Note that you &#39;</span>
                               <span class="s1">&#39;will have to set build options (e.g. the &#39;</span>
                               <span class="s1">&#39;directory) and defaultclock.dt again.&#39;</span><span class="p">)</span>
        <span class="c1"># TODO: remove this when #83 is fixed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_on_run</span><span class="p">:</span>
            <span class="n">run_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_queue</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s1">&#39;run_network&#39;</span><span class="p">:</span>
                    <span class="n">run_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">run_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Multiple run statements are currently error prone. &quot;</span>
                            <span class="s2">&quot;See #83, #85, #86.&quot;</span><span class="p">)</span>

        <span class="n">renames</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;project_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;directory&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;compile_project&#39;</span><span class="p">:</span> <span class="s1">&#39;compile&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;run_project&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwds</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">kwd</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwd</span> <span class="ow">in</span> <span class="n">renames</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Keyword argument &#39;</span><span class="si">%s</span><span class="s2">&#39; has been renamed to &quot;</span>
                            <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwd</span><span class="p">,</span> <span class="n">renames</span><span class="p">[</span><span class="n">kwd</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Unknown keyword argument &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span> <span class="o">%</span> <span class="n">kwd</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">disable_asserts</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;You have disabled asserts in debug mode. Are you sure this is what you wanted to do?&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">additional_source_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_source_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">additional_header_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_header_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">main_includes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">main_includes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">run_includes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_includes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">run_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">cpp_compiler</span><span class="p">,</span> <span class="n">cpp_extra_compile_args</span> <span class="o">=</span> <span class="n">get_compiler_and_args</span><span class="p">()</span>
        <span class="n">cpp_compiler_flags</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpp_extra_compile_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_dir</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="n">ensure_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;code_objects&#39;</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">,</span> <span class="s1">&#39;static_arrays&#39;</span><span class="p">]:</span>
            <span class="n">ensure_directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>

        <span class="n">writer</span> <span class="o">=</span> <span class="n">CUDAWriter</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">diagnostic</span><span class="p">(</span><span class="s2">&quot;Writing CUDA standalone project to directory &quot;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_static_arrays</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_synapses</span><span class="p">()</span>

        <span class="c1"># Not sure what the best place is to call Network.after_run -- at the</span>
        <span class="c1"># moment the only important thing it does is to clear the objects stored</span>
        <span class="c1"># in magic_network. If this is not done, this might lead to problems</span>
        <span class="c1"># for repeated runs of standalone (e.g. in the test suite).</span>
        <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">:</span>
            <span class="n">net</span><span class="o">.</span><span class="n">after_run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_main_source</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">main_includes</span><span class="p">)</span>

        <span class="c1"># Create lists of codobjects using rand, randn or binomial across all</span>
        <span class="c1"># runs (needed for variable declarations).</span>
        <span class="c1">#   - Variables needed for device side rand/randn are declared in objects.cu:</span>
        <span class="c1">#     all_code_objects[&#39;rand&#39;/&#39;rand&#39;] are neede in `generate_objects_source`</span>
        <span class="c1">#   - Variables needed for device side binomial functions are initialized in rand.cu:</span>
        <span class="c1">#     all_code_objects[&#39;binomial&#39;] is needed in `generate_rand_source`</span>
        <span class="k">for</span> <span class="n">run_codeobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_objects_per_run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;rand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">run_codeobj</span><span class="p">[</span><span class="s1">&#39;rand&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;randn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">run_codeobj</span><span class="p">[</span><span class="s1">&#39;randn&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;rand_or_randn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">run_codeobj</span><span class="p">[</span><span class="s1">&#39;rand_or_randn&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;binomial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">run_codeobj</span><span class="p">[</span><span class="s1">&#39;binomial&#39;</span><span class="p">])</span>
        <span class="c1"># Device side binomial functions use curand device api. The curand states (one per thread</span>
        <span class="c1"># executed in parallel) are initialized in rand.cu. The `run_codeobj` dictionary above only</span>
        <span class="c1"># collects codeobjects run every tick in the network. Here, we add those codeobjects that</span>
        <span class="c1"># use device side binomial functions and are run only once (e.g. when setting group</span>
        <span class="c1"># variables before run). For rand/randn, the codeobject themselves take care of the</span>
        <span class="c1"># initialization. For binomial, we need to initialize them in rand.cu.</span>
        <span class="c1"># This line needs to be after `self.generate_main_source`, which populates</span>
        <span class="c1"># `self.code_object_with_binomial_separate_call` and before `self.generate_rand_source`</span>
        <span class="k">for</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_object_with_binomial_separate_call</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">codeobj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;binomial&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_code_objects</span><span class="p">[</span><span class="s1">&#39;binomial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">codeobj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_codeobj_source</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_objects_source</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arange_arrays</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">net_synapses</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">static_array_specs</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">networks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_network_source</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_synapses_classes_source</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_run_source</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">run_includes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_rand_source</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_source_files</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

        <span class="n">writer</span><span class="o">.</span><span class="n">source_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_source_files</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">header_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_header_files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_makefile</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">cpp_compiler</span><span class="p">,</span> <span class="n">cpp_compiler_flags</span><span class="p">,</span> <span class="n">nb_threads</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">disable_asserts</span><span class="o">=</span><span class="n">disable_asserts</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using the following preferences for CUDA standalone:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pref_name</span> <span class="ow">in</span> <span class="n">prefs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;devices.cuda_standalone&quot;</span> <span class="ow">in</span> <span class="n">pref_name</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pref_name</span><span class="p">,</span><span class="n">prefs</span><span class="p">[</span><span class="n">pref_name</span><span class="p">]))</span>
 
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using the following brian preferences:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pref_name</span> <span class="ow">in</span> <span class="n">prefs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pref_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pref_name</span><span class="p">,</span><span class="n">prefs</span><span class="p">[</span><span class="n">pref_name</span><span class="p">]))</span>

        <span class="k">if</span> <span class="nb">compile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compile_source</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">cpp_compiler</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">clean</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">with_output</span><span class="p">,</span> <span class="n">run_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="CUDAStandaloneDevice.network_run"><a class="viewcode-back" href="../../reference/brian2cuda.device.CUDAStandaloneDevice.html#brian2cuda.device.CUDAStandaloneDevice.network_run">[docs]</a>    <span class="k">def</span> <span class="nf">network_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">report_period</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">second</span><span class="p">,</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="c1">###################################################</span>
        <span class="c1">### This part is copied from CPPStandaoneDevice ###</span>
        <span class="c1">###################################################</span>
        <span class="k">if</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s1">&#39;Unsupported keyword argument(s) provided for run: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwds</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c1"># We store this as an instance variable for later access by the</span>
        <span class="c1"># `code_object` method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_profiling</span> <span class="o">=</span> <span class="n">profile</span>

        <span class="n">net</span><span class="o">.</span><span class="n">_clocks</span> <span class="o">=</span> <span class="p">{</span><span class="n">obj</span><span class="o">.</span><span class="n">clock</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">objects</span><span class="p">}</span>
        <span class="n">t_end</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">t</span><span class="o">+</span><span class="n">duration</span>
        <span class="k">for</span> <span class="n">clock</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">_clocks</span><span class="p">:</span>
            <span class="n">clock</span><span class="o">.</span><span class="n">set_interval</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">)</span>

        <span class="c1"># Get the local namespace</span>
        <span class="k">if</span> <span class="n">namespace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="n">get_local_namespace</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">net</span><span class="o">.</span><span class="n">before_run</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clocks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">_clocks</span><span class="p">)</span>
        <span class="n">net</span><span class="o">.</span><span class="n">t_</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">t_end</span><span class="p">)</span>

        <span class="c1"># TODO: remove this horrible hack</span>
        <span class="k">for</span> <span class="n">clock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">clocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clock</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;clock&#39;</span><span class="p">:</span>
                <span class="n">clock</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="s1">&#39;_clock&#39;</span>

        <span class="c1"># Extract all the CodeObjects</span>
        <span class="c1"># Note that since we ran the Network object, these CodeObjects will be sorted into the right</span>
        <span class="c1"># running order, assuming that there is only one clock</span>
        <span class="n">code_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">_code_objects</span><span class="p">:</span>
                    <span class="n">code_objects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">obj</span><span class="o">.</span><span class="n">clock</span><span class="p">,</span> <span class="n">codeobj</span><span class="p">))</span>

        <span class="c1"># Code for a progress reporting function</span>
        <span class="n">standard_code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        void report_progress(const double elapsed, const double completed, const double start, const double duration)</span>
<span class="s1">        {</span>
<span class="s1">            if (completed == 0.0)</span>
<span class="s1">            {</span>
<span class="s1">                %STREAMNAME% &lt;&lt; &quot;Starting simulation at t=&quot; &lt;&lt; start &lt;&lt; &quot; s for duration &quot; &lt;&lt; duration &lt;&lt; &quot; s&quot;;</span>
<span class="s1">            } else</span>
<span class="s1">            {</span>
<span class="s1">                %STREAMNAME% &lt;&lt; completed*duration &lt;&lt; &quot; s (&quot; &lt;&lt; (int)(completed*100.) &lt;&lt; &quot;%) simulated in &quot; &lt;&lt; elapsed &lt;&lt; &quot; s&quot;;</span>
<span class="s1">                if (completed &lt; 1.0)</span>
<span class="s1">                {</span>
<span class="s1">                    const int remaining = (int)((1-completed)/completed*elapsed+0.5);</span>
<span class="s1">                    %STREAMNAME% &lt;&lt; &quot;, estimated &quot; &lt;&lt; remaining &lt;&lt; &quot; s remaining.&quot;;</span>
<span class="s1">                }</span>
<span class="s1">            }</span>

<span class="s1">            %STREAMNAME% &lt;&lt; std::endl &lt;&lt; std::flush;</span>
<span class="s1">        }</span>
<span class="s1">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report_func</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">report</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span> <span class="ow">or</span> <span class="n">report</span> <span class="o">==</span> <span class="s1">&#39;stdout&#39;</span><span class="p">:</span>
            <span class="n">report_func</span> <span class="o">=</span> <span class="n">standard_code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%STREAMNAME%&#39;</span><span class="p">,</span> <span class="s1">&#39;std::cout&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">report</span> <span class="o">==</span> <span class="s1">&#39;stderr&#39;</span><span class="p">:</span>
            <span class="n">report_func</span> <span class="o">=</span> <span class="n">standard_code</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%STREAMNAME%&#39;</span><span class="p">,</span> <span class="s1">&#39;std::cerr&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">report_func</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            void report_progress(const double elapsed, const double completed, const double start, const double duration)</span>
<span class="s1">            {</span>
<span class="s1">            %REPORT%</span>
<span class="s1">            }</span>
<span class="s1">            &#39;&#39;&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%REPORT%&#39;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">((</span><span class="s1">&#39;report argument has to be either &quot;text&quot;, &#39;</span>
                             <span class="s1">&#39;&quot;stdout&quot;, &quot;stderr&quot;, or the code for a report &#39;</span>
                             <span class="s1">&#39;function&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">report_func</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_func</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">report_func</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_func</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;The CUDA standalone device does not &#39;</span>
                                          <span class="s1">&#39;support multiple report functions, &#39;</span>
                                          <span class="s1">&#39;each run has to use the same (or &#39;</span>
                                          <span class="s1">&#39;none).&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_func</span> <span class="o">=</span> <span class="n">report_func</span>

        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report_call</span> <span class="o">=</span> <span class="s1">&#39;report_progress&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report_call</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>

        <span class="c1">##############################################################</span>
        <span class="c1">### From here on the code differs from CPPStandaloneDevice ###</span>
        <span class="c1">##############################################################</span>

        <span class="c1"># For each codeobject of this run check if it uses rand, randn or</span>
        <span class="c1"># binomials. Store these as attributes of the codeobject and create</span>
        <span class="c1"># lists of codeobjects that use rand, randn or binomials. This only</span>
        <span class="c1"># checks codeobject in the network, meaning only the ones running every</span>
        <span class="c1"># clock tick.</span>
        <span class="n">code_object_rng</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rand&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;randn&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;rand_or_randn&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;binomial&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">co</span> <span class="ow">in</span> <span class="n">code_objects</span><span class="p">:</span>  <span class="c1"># (clock, code_object)</span>
            <span class="n">binomial_match</span> <span class="o">=</span> <span class="n">check_codeobj_for_rng</span><span class="p">(</span><span class="n">co</span><span class="p">,</span> <span class="n">check_binomial</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">code_object_rng</span><span class="p">[</span><span class="s1">&#39;rand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
                <span class="n">code_object_rng</span><span class="p">[</span><span class="s1">&#39;rand_or_randn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">randn_calls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">code_object_rng</span><span class="p">[</span><span class="s1">&#39;randn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># only add if it wasn&#39;t already added above</span>
                    <span class="n">code_object_rng</span><span class="p">[</span><span class="s1">&#39;rand_or_randn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">binomial_match</span><span class="p">:</span>
                <span class="n">code_object_rng</span><span class="p">[</span><span class="s1">&#39;binomial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>


        <span class="c1"># store the codeobject dictionary for each run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_objects_per_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code_object_rng</span><span class="p">)</span>

        <span class="c1"># To profile SpeedTests, we need to be able to set `profile` in</span>
        <span class="c1"># `set_device`. Here we catch that case.</span>
        <span class="k">if</span> <span class="s1">&#39;profile&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_options</span><span class="p">:</span>
            <span class="n">build_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">build_profile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enable_profiling</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Generate the updaters</span>
        <span class="n">run_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{net.name}</span><span class="s1">.clear();&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">))</span>

        <span class="c1"># create all random numbers needed for the next clock cycle</span>
        <span class="k">for</span> <span class="n">clock</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">_clocks</span><span class="p">:</span>
            <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{net.name}</span><span class="s1">.add(&amp;</span><span class="si">{clock.name}</span><span class="s1">, _run_random_number_buffer);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">clock</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">))</span>

        <span class="n">all_clocks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">clock</span><span class="p">,</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="n">code_objects</span><span class="p">:</span>
            <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{net.name}</span><span class="s1">.add(&amp;</span><span class="si">{clock.name}</span><span class="s1">, _run_</span><span class="si">{codeobj.name}</span><span class="s1">);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">clock</span><span class="p">,</span>
                                                                                          <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">=</span><span class="n">codeobj</span><span class="p">))</span>
            <span class="n">all_clocks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clock</span><span class="p">)</span>

        <span class="c1"># Under some rare circumstances (e.g. a NeuronGroup only defining a</span>
        <span class="c1"># subexpression that is used by other groups (via linking, or recorded</span>
        <span class="c1"># by a StateMonitor) *and* not calculating anything itself *and* using a</span>
        <span class="c1"># different clock than all other objects) a clock that is not used by</span>
        <span class="c1"># any code object should nevertheless advance during the run. We include</span>
        <span class="c1"># such clocks without a code function in the network.</span>
        <span class="k">for</span> <span class="n">clock</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">_clocks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clock</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_clocks</span><span class="p">:</span>
                <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{net.name}</span><span class="s1">.add(&amp;</span><span class="si">{clock.name}</span><span class="s1">, NULL);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clock</span><span class="o">=</span><span class="n">clock</span><span class="p">,</span> <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">))</span>

        <span class="c1"># In our benchmark scripts we run one example `nvprof` run,</span>
        <span class="c1"># which is informative especially when not running in profile</span>
        <span class="c1"># mode. In order to have the `nvprof` call only profile the</span>
        <span class="c1"># kernels which are run every timestep, we add</span>
        <span class="c1"># `cudaProfilerStart()`, `cudaDeviceSynchronize()` and</span>
        <span class="c1"># `cudaProfilerStop()`. But this might be confusing for anybody</span>
        <span class="c1"># who runs `nvprof` on their generated code, since it will not</span>
        <span class="c1"># report any profiling info about kernels, that initialise</span>
        <span class="c1"># things only once in the beginning? Maybe get rid of it in a</span>
        <span class="c1"># release version? (TODO)</span>
        <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CUDA_SAFE_CALL(cudaProfilerStart());&#39;</span><span class="p">)</span>
        <span class="c1"># run everything that is run on a clock</span>
        <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{net.name}</span><span class="s1">.run(</span><span class="si">{duration!r}</span><span class="s1">, </span><span class="si">{report_call}</span><span class="s1">, </span><span class="si">{report_period!r}</span><span class="s1">);&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span>
                                                                                              <span class="n">duration</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">duration</span><span class="p">),</span>
                                                                                              <span class="n">report_call</span><span class="o">=</span><span class="n">report_call</span><span class="p">,</span>
                                                                                              <span class="n">report_period</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">report_period</span><span class="p">)))</span>
        <span class="c1"># for multiple runs, the random number buffer needs to be reset</span>
        <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;random_number_buffer.run_finished();&#39;</span><span class="p">)</span>
        <span class="c1"># nvprof stuff</span>
        <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CUDA_SAFE_CALL(cudaDeviceSynchronize());&#39;</span><span class="p">)</span>
        <span class="n">run_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;CUDA_SAFE_CALL(cudaProfilerStop());&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;run_network&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">run_lines</span><span class="p">)))</span>

        <span class="c1"># Manually set the cache for the clocks, simulation scripts might</span>
        <span class="c1"># want to access the time (which has been set in code and is therefore</span>
        <span class="c1"># not accessible by the normal means until the code has been built and</span>
        <span class="c1"># run)</span>
        <span class="k">for</span> <span class="n">clock</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">_clocks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array_cache</span><span class="p">[</span><span class="n">clock</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;timestep&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">clock</span><span class="o">.</span><span class="n">_i_end</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array_cache</span><span class="p">[</span><span class="n">clock</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">clock</span><span class="o">.</span><span class="n">_i_end</span> <span class="o">*</span> <span class="n">clock</span><span class="o">.</span><span class="n">dt_</span><span class="p">])</span>

        <span class="c1"># Initialize eventspaces with -1 before the network runs</span>
        <span class="k">for</span> <span class="n">codeobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_objects</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">==</span> <span class="s2">&quot;threshold&quot;</span> <span class="ow">or</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">==</span> <span class="s2">&quot;spikegenerator&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;space&#39;</span><span class="p">):</span>  <span class="c1"># get the correct eventspace name</span>
                        <span class="c1"># In case of custom scheduling, the thresholder might come after synapses or monitors</span>
                        <span class="c1"># and needs to be initialized in the beginning of the simulation</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">main_queue</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;set_by_constant&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_array_name</span><span class="p">(</span><span class="n">codeobj</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="kc">False</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_on_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_been_run</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The network has already been built and run &#39;</span>
                                   <span class="s1">&#39;before. Use set_device with &#39;</span>
                                   <span class="s1">&#39;build_on_run=False and an explicit &#39;</span>
                                   <span class="s1">&#39;device.build call to use multiple run &#39;</span>
                                   <span class="s1">&#39;statements with this device.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">direct_call</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">build_options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">first_run</span> <span class="o">=</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="check_codeobj_for_rng"><a class="viewcode-back" href="../../reference/brian2cuda.device.check_codeobj_for_rng.html#brian2cuda.device.check_codeobj_for_rng">[docs]</a><span class="k">def</span> <span class="nf">check_codeobj_for_rng</span><span class="p">(</span><span class="n">codeobj</span><span class="p">,</span> <span class="n">check_binomial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Count the number of `&quot;rand()&quot;` and `&quot;randn()&quot;` appearances in</span>
<span class="sd">    `codeobj.code.cu_file` and store them as attributes in `codeobj.rand_calls`</span>
<span class="sd">    and `codeobj.randn_calls`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    codeobj: CodeObjects</span>
<span class="sd">        Codeobject with generated CUDA code in `codeobj.code.cu_file`.</span>
<span class="sd">    check_binomial: bool, optional</span>
<span class="sd">        Wether to also check if `&quot;binomial()&quot;` appears. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    binomial_match: bool or None</span>
<span class="sd">        If `check_binomial` is True, this tells if `binomial(const int</span>
<span class="sd">        vectorisation_idx)` is appearing in `code`, else `None`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># synapses_create_generator uses host side random number generation</span>
    <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">==</span> <span class="s1">&#39;synapses_create_generator&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">check_binomial</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># regex explained</span>
    <span class="c1"># (?&lt;!...) negative lookbehind: don&#39;t match if ... preceeds</span>
    <span class="c1">#     XXX: This only excludes #define lines which have exactly one space to &#39;_rand&#39;.</span>
    <span class="c1">#          As long is we don&#39;t have &#39;#define  _rand&#39; with 2 spaces, thats fine.</span>
    <span class="c1"># \b - non-alphanumeric character (word boundary, does not consume a character)</span>
    <span class="n">rand_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;!#define )\b_rand\(_vectorisation_idx\)&#39;</span>
    <span class="n">matches_rand</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">rand_pattern</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span><span class="p">)</span>
    <span class="n">codeobj</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches_rand</span><span class="p">)</span>

    <span class="n">randn_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?&lt;!#define )\b_randn\(_vectorisation_idx\)&#39;</span>
    <span class="n">matches_randn</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">randn_pattern</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span><span class="p">)</span>
    <span class="n">codeobj</span><span class="o">.</span><span class="n">randn_calls</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches_randn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">==</span> <span class="s1">&#39;synapses&#39;</span><span class="p">:</span>
        <span class="c1"># We have two if/else code paths in synapses code (homog. / heterog. delay mode),</span>
        <span class="c1"># therefore we have twice as much matches for rand/randn</span>
        <span class="k">assert</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">randn_calls</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">codeobj</span><span class="o">.</span><span class="n">randn_calls</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="n">codeobj</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">/=</span> <span class="mi">2</span>

    <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">rand_calls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># substitute rand/n arguments twice for synapses templates</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">==</span> <span class="s1">&#39;synapses&#39;</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">rand_calls</span><span class="p">):</span>
                <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="n">rand_pattern</span><span class="p">,</span>
                    <span class="s2">&quot;_rand(_vectorisation_idx + </span><span class="si">{i}</span><span class="s2"> * _N)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">),</span>
                    <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span><span class="p">,</span>
                    <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">randn_calls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># substitute rand/n arguments twice for synapses templates</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">template_name</span> <span class="o">==</span> <span class="s1">&#39;synapses&#39;</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">randn_calls</span><span class="p">):</span>
                <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="n">randn_pattern</span><span class="p">,</span>
                    <span class="s2">&quot;_randn(_vectorisation_idx + </span><span class="si">{i}</span><span class="s2"> * _N)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">),</span>
                    <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span><span class="p">,</span>
                    <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">binomial</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">check_binomial</span><span class="p">:</span>
        <span class="n">binomial</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;_binomial\w*\(const int vectorisation_idx\)&#39;</span><span class="p">,</span> <span class="n">codeobj</span><span class="o">.</span><span class="n">code</span><span class="o">.</span><span class="n">cu_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">binomial</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">binomial</span></div>


<span class="n">cuda_standalone_device</span> <span class="o">=</span> <span class="n">CUDAStandaloneDevice</span><span class="p">()</span>

<span class="n">all_devices</span><span class="p">[</span><span class="s1">&#39;cuda_standalone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cuda_standalone_device</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">brian2cuda</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/preferences.html">Brian2cuda specific preferences</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/brian2cuda.html">Reference documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021-, Brian2Cuda authors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>